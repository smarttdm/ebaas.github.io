---
layout: post
title:  "生成PDF报告"
date:   2018-03-09
visible: 1
---

#### 概述

前面教程介绍了生成Excel报告的配置方法。在许多应用场景需要生成PDF的报告，例如事务处理报告和试验报告等业务报告。报告的内容和格式根据需求而变化并且非常动态。采用代码开发的方式实现这类报告将非常费时费力，而且不容易修改。不能满足许多生成报告场景的要求。因而，需要提供一种灵活和省时的方法来应对生成PDF报告的需求。

Ebaas平台（7.4.0以上版本）提供了一种基于XSL-FO模板及XML数据生成PDF报告的机制。其中XSL-FO模板负责定义报告的显示格式，XML提供报告中的数据。报告生成引擎使用XSL-FO模板和XML数据作为输入，动态地生成PDF报告。

这个机制的好处是无需编写任何代码，通过配置就能灵活应对各种复杂的报告生成需求。

XSL-FO格式化规范是W3C的建议的标准。XSL-FO定义了许多XML标记，这些标记描述了应如何显示内容。结合XSL脚本，XL-FO可以定义各种复杂的报告显示要求，是非常强大而且易学的一种语言。如果您想深入研究XSL-FO，可以到W3C的网站直接查阅该规范的文档。本教程将不做深入的介绍。

下面，我们通过一个生成报告的例子介绍配置生成事务报告（PDF）的步骤。

#### 导出XML数据

首先，我们需要导出一个创建报告模板所需的XML数据。因为在创建XSL-FO模板时需要在不同的位置应用XML数据的元素，这样在最终生成PDF报告时，生成报告的引擎能从动态生成的XML数据中选择相应元素的数据并将数据插入到报告的具体位置。

导出事务的XML数据结构是依据所使用的XML架构。我们在前面教程介绍了如何在“事务”数据类上创建XML架构。如果您没有创建事务的XML架构，请参看这个教程。

* 打开DesignStudio，以admin用户登录到“事务跟踪管理”数据库；
* 进入DS的“数据编辑器”，左边菜单选择“事务”数据类后，右边表格显示事务数据实例；
* 鼠标右键点击一条事务数据实例，从弹出的菜单中选择“导出XML...”，见下图；

<img src="{{'/assets/img/2018-3-9-2-导出XML数据.png' | prepend: site.baseurl }}" alt="">

* 从弹出的“XML架构”窗口中选择“事务XML架构”，点击“确认”；

<img src="{{'/assets/img/2018-3-9-2-选择XML架构.png' | prepend: site.baseurl }}" alt="">

* 将生成的XML数据保存为一个xml文件在本地；
* 使用文本编辑器打开保存的xml文件，显示的内容如下图；

<img src="{{'/assets/img/2018-3-9-2-事务XML数据.png' | prepend: site.baseurl }}" alt="">

#### 创建报告模板

#### 部署报告模板

将创建的XSL-FO模板文件手工复制到下面所示的目录下。如果第一次部署模板，部分目录路径不存在，需要手工创建后再将模板文件复制粘贴进去。

{% highlight ruby %}
C:\Program Files\Ebaas\Templates\Reports\事务跟踪管理 1.0\Issue

“事务跟踪管理 1.0”为数据库名称和版本号（注意：中间有一个空格）；
“Issue”为“事务”数据类的英文名；
{% endhighlight %}

#### 创建“生成PDF报告”定制命令

使用SiteMapStudio为“事务”数据类创建一个“生成PDF报告”的定制命令，步骤如下：

* 从“开始”菜单 => Ebaas => SiteMapStudio打开SiteMapStudio工具 => “文件” => “打开” => 登录为admin；
* 右键点击“事务跟踪管理”下的“事务命令组”节点 => 在弹出的“菜单”中选择“添加” => 在弹出的“添加新项”名称栏输入：PDFReport => 确定”;
* 选择新创建的“PDFReport”定制命令，在“设置”选项卡中按照下表的参数进行设置：

| 设置参数名 | 设置参数值 | 描述 |
|-------|--------|---------|
| 名称 | PDFReport | 定制命令的名称，必须是唯一的 |
| 显示名 | 生成PDF报告 | 定制命令在用户界面显示的名称 |
| 模块URL | .report | 定制命令使用的界面模块，该模块是生成报告的模块 |
| 图标名称 | fa fa-lg fa-file-pdf-o | 定制命令显示的PDF图标 |

点击“模块参数”右边“...”按钮 => 在弹出的“定义参数”框 => 点击“添加”按钮 => 按照下表设置参数：

| 设置参数名 | 设置参数值 | 描述 |
|-------|--------|---------|
| template | issueReport.xsl | 指定生成报告的XSL-FO模板 |

配置结果如下图所示：

<img src="{{'/assets/img/2018-3-9-2-创建生成PDF报告定制命令.png' | prepend: site.baseurl }}" alt="">

点击“文件” => 选择“保存”。

{% include important.html content="保存后请重启Ebaas服务器。" %}

#### 测试生成PDF报告

* 使用浏览器连接到http://localhost:8080；
* 登录为用户demo1 (登录名：demo1， 密码：888）；
* 在首页点击“事务管理”图标 => 进入“事务”表格；
* 单击一条数据实例 => 在展开的下拉工具栏，可见“生成PDF报告”图标，如下图所示：

<img src="{{'/assets/img/2018-3-9-2-显示生成报告定制命令.png' | prepend: site.baseurl }}" alt="">

* 点击“生成报告”图标，弹出确认窗口，再点击“生成并下载报告”按键，经过稍许等待服务器生成报告后，会下载为PDF报告文件。

<img src="{{'/assets/img/2018-3-9-2-generated-report.png' | prepend: site.baseurl }}" alt="">

基于XSL-FO和XML的生成报告机制可以生成任意复杂的报告格式。您可以深入了解XSL-FO的标识的用法，定义更复杂的报告模板。可查看参考资料：<a class='post-link' href='http://www.xmlpdf.com/builds/ibex.pdf'>Ibex PDF使用文档</a> 
